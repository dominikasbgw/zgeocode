<%@page language="abap" %>                                                                                                                                                                                                                                     
<%                                                                                                                                                                                                                                                             
DATA: lat TYPE string,                                                                                                                                                                                                                                         
      lon TYPE string.                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
zcl_geocode_helper=>convert_geodata_for_javascript(                                                                                                                                                                                                            
  EXPORTING                                                                                                                                                                                                                                                    
    i_geodata = geodata                                                                                                                                                                                                                                        
  IMPORTING                                                                                                                                                                                                                                                    
    lat       = lat                                                                                                                                                                                                                                            
    lon       = lon                                                                                                                                                                                                                                            
).                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
%>                                                                                                                                                                                                                                                             
<html>                                                                                                                                                                                                                                                         
  <head>                                                                                                                                                                                                                                                       
    <title>OpenStreetMap</title>                                                                                                                                                                                                                               
    <!-- bring in the OpenLayers javascript library                                                                                                                                                                                                            
         (here we bring it from the remote site, but you could                                                                                                                                                                                                 
         easily serve up this javascript yourself) -->                                                                                                                                                                                                         
    <script src="https://openlayers.org/api/2.13.1/OpenLayers.js" type="text/javascript"></script>                                                                                                                                                             
    <!-- bring in the OpenStreetMap OpenLayers layers.                                                                                                                                                                                                         
         Using this hosted file will make sure we are kept up                                                                                                                                                                                                  
         to date with any necessary changes -->                                                                                                                                                                                                                
    <script src="https://www.openstreetmap.org/openlayers/OpenStreetMap.js" type="text/javascript"></script>                                                                                                                                                   
    <script type="text/javascript">                                                                                                                                                                                                                            
        // Start position for the map                                                                                                                                                                                                                          
        var lat=<%= lat %>;                                                                                                                                                                                                                                    
        var lon=<%= lon %>;                                                                                                                                                                                                                                    
        var zoom=13;                                                                                                                                                                                                                                           
        var map; //complex object of type OpenLayers.Map                                                                                                                                                                                                       
        var layer_mapnik;                                                                                                                                                                                                                                      
        var layer_bp;                                                                                                                                                                                                                                          
        //Initialise the 'map' object                                                                                                                                                                                                                          
        function init() {                                                                                                                                                                                                                                      
            map = new OpenLayers.Map ("map", {                                                                                                                                                                                                                 
                controls:[                                                                                                                                                                                                                                     
                    new OpenLayers.Control.Navigation(),                                                                                                                                                                                                       
                    new OpenLayers.Control.PanZoomBar(),                                                                                                                                                                                                       
                    new OpenLayers.Control.Permalink(),                                                                                                                                                                                                        
                    new OpenLayers.Control.ScaleLine(),                                                                                                                                                                                                        
                    new OpenLayers.Control.Permalink('permalink'),                                                                                                                                                                                             
                    new OpenLayers.Control.MousePosition(),                                                                                                                                                                                                    
                    new OpenLayers.Control.Attribution()],                                                                                                                                                                                                     
                maxExtent: new OpenLayers.Bounds(-20037508.34,-20037508.34,20037508.34,20037508.34),                                                                                                                                                           
                maxResolution: 156543.0399,                                                                                                                                                                                                                    
                numZoomLevels: 19,                                                                                                                                                                                                                             
                units: 'm',                                                                                                                                                                                                                                    
                projection: new OpenLayers.Projection("EPSG:900913"),                                                                                                                                                                                          
                displayProjection: new OpenLayers.Projection("EPSG:4326")                                                                                                                                                                                      
            } );                                                                                                                                                                                                                                               
            // Define the map layer                                                                                                                                                                                                                            
            /*                                                                                                                                                                                                                                                 
            var layer_mapnik = new OpenLayers.Layer.OSM(                                                                                                                                                                                                       
              "OpenStreetMap",                                                                                                                                                                                                                                 
              "http://b.tile.openstreetmap.org/${z}/${x}/${y}.png",                                                                                                                                                                                            
              {numZoomLevels: 19}                                                                                                                                                                                                                              
            );                                                                                                                                                                                                                                                 
            */                                                                                                                                                                                                                                                 
            var layer_mapnik = new OpenLayers.Layer.OSM.Mapnik("Mapnik");                                                                                                                                                                                      
            layer_bp = new OpenLayers.Layer.Markers(                                                                                                                                                                                                           
              "Business Partner",                                                                                                                                                                                                                              
              {                                                                                                                                                                                                                                                
                projection: new OpenLayers.Projection("EPSG:4326"),                                                                                                                                                                                            
                visibility: true,                                                                                                                                                                                                                              
                displayInLayerSwitcher: true                                                                                                                                                                                                                   
              }                                                                                                                                                                                                                                                
            );                                                                                                                                                                                                                                                 
            map.addLayers([layer_mapnik, layer_bp]);                                                                                                                                                                                                           
            if( ! map.getCenter() ){                                                                                                                                                                                                                           
                var lonLat = new OpenLayers.LonLat(lon, lat).transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject());                                                                                                                     
                map.setCenter (lonLat, zoom);                                                                                                                                                                                                                  
            }                                                                                                                                                                                                                                                  
            loadBusinessPartner();                                                                                                                                                                                                                             
        }                                                                                                                                                                                                                                                      
        function loadBusinessPartner() {                                                                                                                                                                                                                       
          var size = new OpenLayers.Size(21,25);                                                                                                                                                                                                               
          var offset = new OpenLayers.Pixel(-(size.w/2), -size.h);                                                                                                                                                                                             
          var icon = new OpenLayers.Icon('http://www.openlayers.org/api/img/marker.png',size,offset);                                                                                                                                                          
          addMarker(layer_bp, <%= lon %>, <%= lat %>, '<%= BP %>', icon);                                                                                                                                                                                      
          <%                                                                                                                                                                                                                                                   
          DATA: bp_nearby LIKE LINE OF bps_nearby.                                                                                                                                                                                                             
          LOOP AT bps_nearby INTO bp_nearby.                                                                                                                                                                                                                   
            zcl_geocode_helper=>convert_geodata_for_javascript(                                                                                                                                                                                                
              EXPORTING                                                                                                                                                                                                                                        
                i_geodata = bp_nearby-geodata                                                                                                                                                                                                                  
              IMPORTING                                                                                                                                                                                                                                        
                lat       = lat                                                                                                                                                                                                                                
                lon       = lon                                                                                                                                                                                                                                
            ). %>                                                                                                                                                                                                                                              
            icon = new OpenLayers.Icon('http://www.openlayers.org/api/img/marker-green.png',size,offset);                                                                                                                                                      
            addMarker(layer_bp, <%= lon %>, <%= lat %>, '<%= bp_nearby-PARTNER %>, <%= bp_nearby-NAME %>, <%= bp_nearby-DISTANCE %>', icon );                                                                                                                  
            <%                                                                                                                                                                                                                                                 
          ENDLOOP.                                                                                                                                                                                                                                             
          %>                                                                                                                                                                                                                                                   
        }                                                                                                                                                                                                                                                      
        function addMarker(layer, lon, lat, popupContentHTML, icon) {                                                                                                                                                                                          
            var ll =                                                                                                                                                                                                                                           
              new OpenLayers.LonLat(lon, lat).transform(                                                                                                                                                                                                       
                new OpenLayers.Projection("EPSG:4326"),                                                                                                                                                                                                        
                map.getProjectionObject()                                                                                                                                                                                                                      
              );                                                                                                                                                                                                                                               
            var feature = new OpenLayers.Feature(layer, ll);                                                                                                                                                                                                   
            feature.closeBox = true;                                                                                                                                                                                                                           
            feature.popupClass =                                                                                                                                                                                                                               
              OpenLayers.Class(                                                                                                                                                                                                                                
                OpenLayers.Popup.FramedCloud,                                                                                                                                                                                                                  
                { minSize: new OpenLayers.Size(200, 100) }                                                                                                                                                                                                     
              );                                                                                                                                                                                                                                               
            feature.data.popupContentHTML = popupContentHTML;                                                                                                                                                                                                  
            feature.data.overflow = "hidden";                                                                                                                                                                                                                  
            var marker = new OpenLayers.Marker(ll, icon);                                                                                                                                                                                                      
            marker.feature = feature;                                                                                                                                                                                                                          
            var markerClick = function(evt) {                                                                                                                                                                                                                  
                if (this.popup == null) {                                                                                                                                                                                                                      
                    this.popup = this.createPopup(this.closeBox);                                                                                                                                                                                              
                    map.addPopup(this.popup);                                                                                                                                                                                                                  
                    this.popup.show();                                                                                                                                                                                                                         
                } else {                                                                                                                                                                                                                                       
                    this.popup.toggle();                                                                                                                                                                                                                       
                }                                                                                                                                                                                                                                              
                OpenLayers.Event.stop(evt);                                                                                                                                                                                                                    
            };                                                                                                                                                                                                                                                 
            marker.events.register("mousedown", feature, markerClick);                                                                                                                                                                                         
            layer.addMarker(marker);                                                                                                                                                                                                                           
        }                                                                                                                                                                                                                                                      
    </script>                                                                                                                                                                                                                                                  
</head>                                                                                                                                                                                                                                                        
<!-- body.onload is called once the page is loaded (call the 'init' function) -->                                                                                                                                                                              
<body onload="init();" style="margin: 0px;padding: 0px;">                                                                                                                                                                                                      
    <!-- define a DIV into which the map will appear. Make it take up the whole window -->                                                                                                                                                                     
    <div style="width:100%; height:100%" id="map"></div>                                                                                                                                                                                                       
</body>                                                                                                                                                                                                                                                        
</html>                                                                                                                                                                                                                                                        